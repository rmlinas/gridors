---
import { Image } from 'astro:assets';
import { getCollection, type CollectionEntry } from 'astro:content';
import { format } from 'date-fns';
import path from 'node:path';
import fs from 'node:fs';

import gridorsLogo from '../assets/images/logo.png';
import astroFallbackImage from '../assets/astro.svg';

interface Props {
  className?: string;
}
const { className } = Astro.props;

// --- Dinaminis turinys ---

const blogPosts = await getCollection('blog', ({ data }) => !data.draft);
const guidePosts = await getCollection('guides', ({ data }) => !data.draft);
const reviewPosts = await getCollection('reviews', ({ data }) => !data.draft);

// NAUJA: ApibrÄ—Å¾kite tipÄ… sujungtiems turinio Ä¯raÅ¡ams
interface SidebarPostData {
  slug: string;
  collection: string;
  title: string;
  pubDate: Date | string; // Gali bÅ«ti Date objektas arba stringas iÅ¡ frontmatter
  image?: string; // Optional image field
  // LeidÅ¾iame ir bet kokias kitas savybes iÅ¡ frontmatter
  [key: string]: any; 
}

const allContent: SidebarPostData[] = [ // Nurodome allContent tipÄ…
  ...blogPosts.map(p => ({ ...p.data as Record<string, any>, slug: p.slug, collection: 'blog' })),
  ...guidePosts.map(p => ({ ...p.data as Record<string, any>, slug: p.slug, collection: 'guides' })),
  ...reviewPosts.map(p => ({ ...p.data as Record<string, any>, slug: p.slug, collection: 'reviews' })), // Pataisyta eilutÄ—
];

const sortedContent = allContent.sort((a, b) => {
  const dateA = new Date(a.pubDate ?? 0).getTime();
  const dateB = new Date(b.pubDate ?? 0).getTime();
  return dateB - dateA;
});

const latestPosts = sortedContent.slice(0, 3);

const getPostHref = (slug: string, collection: string) => {
  if (collection === 'blog') return `/blog/${slug}/`;
  if (collection === 'guides') return `/guides/${slug}/`;
  if (collection === 'reviews') return `/reviews/${slug}/`;
  return `/${slug}/`;
};

// --- NAUJAS: DinaminÄ—s 'Guides' kategorijos iÅ¡ katalogÅ³ ---

const guidesContentDir = path.join(process.cwd(), 'src', 'content', 'guides');
const guideCategoryDirectories = fs.readdirSync(guidesContentDir, { withFileTypes: true })
                                   .filter(dirent => dirent.isDirectory())
                                   .map(dirent => dirent.name);

const dynamicGuidesCategoriesMap = new Map<string, { count: number; href: string; icon: string; originalTitle: string }>();

// IkonÅ³ Å¾emÄ—lapis pagal slugified katalogo pavadinimÄ… (galite plÄ—sti)
const categoryIconsBySlug = {
  "animals-guides": "ðŸ¾",
  "diy-skills": "ðŸ”§",
  "garden-guides": "ðŸŒ±",
  "kitchen": "ðŸ³",
  "natural-recipes": "ðŸŒ¿",
  "off-grid-living": "âš¡",
};

guideCategoryDirectories.forEach(dirName => {
  const originalTitle = dirName.replace(/-/g, ' ')
                               .split(' ')
                               .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                               .join(' ');

  const categorySlug = dirName;
  const categoryHref = `/guides/${categorySlug}/`;
  const icon = categoryIconsBySlug[dirName as keyof typeof categoryIconsBySlug] || "ðŸ“–";

  const count = guidePosts.filter(guide => guide.slug.startsWith(`${dirName}/`)).length;

  if (count > 0) {
    dynamicGuidesCategoriesMap.set(originalTitle, {
      count: count,
      href: categoryHref,
      icon: icon,
      originalTitle: originalTitle
    });
  }
});

const guideCategories = Array.from(dynamicGuidesCategoriesMap.values()).sort((a, b) => a.originalTitle.localeCompare(b.originalTitle));

---

<aside class={`${className ?? ''} space-y-8`}>

  <div class="base-card-block p-6 text-center">
    <Image
      src={gridorsLogo}
      alt="Gridors Logo"
      width={48}
      height={48}
      class="mx-auto mb-4"
      loading="eager"
      format="webp"
      densities={[1.5, 2]}
    />
    <p class="text-sm text-gray-700 leading-relaxed">
      In an uncertain world, self-reliance isn't a hobbyâ€”it's a core competency.
      Gridors is your strategic resource for the field-tested blueprints and skills needed to forge a resilient future.
    </p>
    <a href="/about"
       class="inline-block mt-4 px-4 py-2 text-sm font-medium text-green-700 border border-green-600 rounded-md hover:bg-green-600 hover:text-white transition">
      Discover Our Doctrine
    </a>
  </div>

  <div class="content-panel">
    <h4 class="section-title mb-5">Guides</h4>
    <ul class="space-y-3">
      {guideCategories.map(item => (
        <li class="group flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
          <a href={item.href} class="flex items-center text-gray-700 group-hover:text-green-600 transition-colors">
            <span class="text-xl mr-3" set:html={item.icon}></span>
            <span>{item.originalTitle}</span>
          </a>
          {item.count !== undefined && (
            <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">
              {item.count}
            </span>
          )}
        </li>
      ))}
    </ul>
  </div>

  <div class="content-panel">
    <h4 class="section-title mb-5">Latest Posts</h4>
    <div class="space-y-5">
      {latestPosts.map(post => (
        <a href={getPostHref(post.slug, post.collection)} class="group flex items-start p-3 -m-3 rounded-lg hover:bg-gray-50 transition-colors">
          <div class="flex-shrink-0">
            {typeof post.image === 'string' && post.image.length > 0 ? (
              <img
                src={post.image}
                alt={post.title}
                class="h-16 w-16 rounded-lg object-cover shadow-sm border border-gray-200"
                loading="lazy"
              />
            ) : (
              <Image
                src={astroFallbackImage}
                alt={`No image for ${post.title}`}
                width={64}
                height={64}
                class="h-16 w-16 rounded-lg object-cover shadow-sm border border-gray-200 p-2"
                loading="lazy"
              />
            )}
          </div>
          <div class="ml-4">
            <h5 class="font-semibold text-gray-900 group-hover:text-green-700 transition-colors">
              {post.title}
            </h5>
            <p class="text-xs text-gray-500 mt-1">{post.pubDate ? format(new Date(post.pubDate), 'MMMM d,PPPP') : 'Date N/A'}</p>
          </div>
        </a>
      ))}
      {latestPosts.length === 0 && (
        <p class="text-gray-600 text-sm">No recent posts available.</p>
      )}
    </div>
  </div>

  <div class="base-card-block p-6 text-center">
    <h4 class="section-title">Subscribe to Newsletter</h4>
    <p class="mt-3 text-gray-700">
      Get exclusive content and resources delivered to your inbox
    </p>
    <form class="mt-5 space-y-4">
      <div>
        <input
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
          type="email"
          placeholder="Your email address"
          required
        />
      </div>
      <button
        class="btn w-full py-3 font-medium"
        type="submit"
      >
        <span class="mr-2">ðŸ‘‰</span> Subscribe Now
      </button>
    </form>
    <p class="mt-3 text-xs text-gray-500">
      No spam. Unsubscribe anytime.
    </p>
  </div>

</aside>